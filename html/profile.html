<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>프로필</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter 로드 -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* 인라인 스타일로 기본 레이아웃과 버튼 스타일 추가 */
      body {
        font-family: "Inter", sans-serif; /* Google Fonts Inter 적용 */
        margin: 0;
        padding: 0;
        background-color: #f4f7f6;
        color: #333;
      }
      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .toolbar-left .logo {
        font-size: 24px;
        font-weight: bold;
        color: #3b82f6;
        text-decoration: none;
      }
      .toolbar-right {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        gap: 20px;
      }
      .toolbar-right li a {
        text-decoration: none;
        color: #555;
        font-weight: 600;
        transition: color 0.2s ease-in-out;
      }
      .toolbar-right li a:hover {
        color: #3b82f6;
      }

      /* 사용자 제공 CSS (memberInfo 관련) */
      .memberInfo {
        display: flex;
        flex-direction: row; /* 수평 정렬 */
        justify-content: center; /* 가운데 정렬 */
        gap: 10px; /* 버튼 간 간격 */
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .memberInfo li a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        text-decoration: none;
        color: black;
        font-size: 0.875rem; /* text-sm에 해당 */
        font-weight: 500; /* medium */
      }
      .memberInfo li a img {
        display: block;
        width: 36px; /* 이미지 크기 */
        height: 36px;
        margin-bottom: 4px; /* 이미지와 텍스트 사이 간격 */
      }

      .profile-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .profile-header {
        display: flex;
        align-items: flex-start; /* Align items to the start for proper vertical spacing */
        gap: 30px;
        padding-bottom: 30px;
        border-bottom: 1px solid #eee;
      }

      /* --- MODIFIED CSS for image section and button --- */
      .image-section {
        display: flex; /* Use flexbox */
        flex-direction: column; /* Stack children vertically */
        align-items: center; /* Center horizontally */
        flex-shrink: 0;
      }

      .profile-image-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid #3b82f6;
        margin-bottom: 10px; /* Space between image and button */
      }

      .profile-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .small-button {
        background-color: #3b82f6; /* Changed to primary button color */
        color: white;
        padding: 8px 15px; /* Adjusted padding */
        border-radius: 5px;
        font-size: 14px; /* Adjusted font size */
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        text-align: center; /* Ensure text is centered within the button */
        display: inline-block; /* Make it an inline-block to respect padding/margin */
      }
      /* --- END MODIFIED CSS --- */

      .small-button:hover {
        background-color: #2a6bbd; /* Darker primary color on hover */
      }
      .profile-info {
        flex-grow: 1;
      }
      .profile-info h2 {
        font-size: 28px;
        margin-bottom: 10px;
        color: #333;
      }
      .profile-info p {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
      }
      .profile-info button {
        background-color: #3b82f6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s ease-in-out;
      }
      .profile-info button:hover {
        background-color: #2a6bbd;
      }

      /* 모달 스타일 */
      .modal {
        display: none; /* 기본적으로 숨김 */
        position: fixed; /* 화면에 고정 */
        z-index: 1000; /* 다른 요소 위에 표시 */
        left: 0;
        top: 0;
        width: 100%; /* 전체 너비 */
        height: 100%; /* 전체 높이 */
        overflow: auto; /* 내용이 넘칠 경우 스크롤 허용 */
        background-color: rgba(0, 0, 0, 0.5); /* 반투명 검정 배경 */
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .modal-content h3 {
        margin-top: 0;
        color: #333;
      }

      .modal-content input[type="text"],
      .modal-content textarea {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .modal-content textarea {
        resize: vertical;
        min-height: 80px;
      }

      /* General modal button style (will be overridden by specific ones below) */
      .modal-content button {
        background-color: #3b82f6;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        transition: background-color 0.2s ease-in-out;
      }

      .modal-content button:hover {
        background-color: #2a6bbd;
      }

      /* Styles for comment action buttons to remove blue background */
      .comment-actions button {
        background: none !important; /* Remove any background */
        box-shadow: none !important; /* Remove any box shadow */
        color: #6b7280; /* text-gray-500 from Tailwind */
        border: none;
        padding: 0;
        margin: 0;
      }

      /* Ensure hover effects are still applied for color change only */
      .comment-actions button:hover {
        color: #3b82f6; /* Blue-500 hover for reply */
      }
      .comment-actions .like-button:hover {
        color: #ef4444; /* Red-500 hover for like */
      }

      /* Stylish Close Button in Post View Modal (X button) */
      #closeCommentModalButton {
        background-color: #60a5fa; /* Tailwind blue-400 for a softer blue */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px; /* Slightly more rounded */
        cursor: pointer;
        font-size: 1rem; /* Base font size */
        transition: background-color 0.2s ease-in-out,
          transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
        position: absolute;
        top: 15px; /* Adjust as needed */
        right: 15px; /* Adjust as needed */
        background: transparent; /* Make it transparent */
        color: #6b7280; /* Gray text color */
        font-size: 2rem; /* Larger 'X' */
        padding: 0;
        line-height: 1; /* Remove extra line height */
        width: auto;
        height: auto;
        box-shadow: none; /* No shadow */
      }
      #closeCommentModalButton:hover {
        background-color: transparent; /* Keep transparent */
        color: #374151; /* Darker gray on hover */
        transform: translateY(0); /* No lift effect for 'X' button */
        box-shadow: none; /* No shadow */
      }
      #closeImageModal,
      #closeEditModal,
      #confirmNoBtn,
      #closeAlertModal {
        background-color: #9ca3af; /* Tailwind gray-400 for a neutral gray */
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px; /* Consistent rounded corners */
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.2s ease-in-out,
          transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* Subtle shadow */
      }
      #closeImageModal:hover,
      #closeEditModal:hover,
      #confirmNoBtn:hover,
      #closeAlertModal:hover {
        background-color: #6b7280; /* Tailwind gray-500 on hover */
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.12);
      }

      /* 전체 삭제 버튼 스타일 */
      #clearAllBtn {
        padding: 10px 20px;
        background-color: #dc3545; /* Red color for delete */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }
      #clearAllBtn:hover {
        background-color: #c82333; /* Darker red on hover */
      }

      /* My Posts Section Styles */
      .my-posts-section {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .post-card {
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        cursor: pointer;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        position: relative; /* For delete button positioning */
        height: 250px; /* Increased height to accommodate image and text */
        overflow: hidden; /* Ensure rounded corners and image fit */
      }

      .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .post-card-image {
        width: 100%;
        height: 120px; /* Fixed height for small image preview in card */
        object-fit: cover;
        border-radius: 8px 8px 0 0; /* Rounded top corners to match card */
        display: block; /* Ensure it behaves as a block element */
        background-color: #e0e0e0; /* Placeholder background */
      }

      .post-card-content-wrapper {
        padding: 15px; /* Add padding to text content wrapper */
        flex-grow: 1; /* Allow content wrapper to take remaining space */
        display: flex;
        flex-direction: column;
      }

      .post-card-title {
        font-weight: 600;
        font-size: 1.125rem; /* text-lg */
        color: #333;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .post-card-text {
        font-size: 0.9375rem; /* ~15px */
        color: #666;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Show max 2 lines to make space for title/image */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1; /* Allows text content to take available space */
      }

      .post-card-delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem; /* text-xs */
        padding: 4px 8px;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        opacity: 0.8;
      }

      .post-card-delete-btn:hover {
        background-color: #c82333;
        opacity: 1;
      }

      #commentModal .modal-content {
        max-width: 1000px;
        width: 90%;
        display: flex;
        min-height: 600px;
        text-align: left;
        position: relative;
      }
      #commentModal .modal-post-display {
        flex: 2;
        border-right: 1px solid #e0e0e0;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      .modal-post-image {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: contain;
        display: block;
        background-color: #e0e0e0;
      }
      #commentModal .modal-comment-area {
        flex: 1;
        padding-left: 24px;
        display: flex;
        flex-direction: column;
      }
      #commentModal .comment-list {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 16px;
      }
      #commentModal .modal-post-content-wrapper {
        padding: 24px;
      }
      #modalCommentInput {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 15px;
        box-sizing: border-box;
        font-size: 0.95rem;
      }
      #modalCommentSubmitButton {
        background-color: #3b82f6;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        transition: background-color 0.2s;
        margin-left: 10px;
      }
      #modalCommentSubmitButton:hover {
        background-color: #2a6bbd;
      }

      .comment-item,
      .reply-item {
        background-color: #fff;
        border: 1px solid #f0f0f0;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      .reply-item {
        margin-left: 20px;
        background-color: #fdfdfd;
      }
      .comment-content-wrapper {
        display: flex;
        flex-direction: column;
        margin-bottom: 4px;
      }
      .comment-text-line {
        display: flex;
        align-items: baseline;
      }
      .comment-text-line .comment-username {
        font-weight: 600;
        color: #1f2937;
        margin-right: 8px;
        font-size: 0.875rem;
      }
      .comment-text-line .comment-body {
        color: #374151;
        font-size: 0.875rem;
        flex: 1;
      }
      .comment-time {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: 4px;
      }

      .comment-actions {
        display: flex;
        align-items: center;
        font-size: 0.75rem;
        color: #6b7280;
        gap: 12px;
        margin-left: 0;
      }
      .comment-actions button {
        display: flex;
        align-items: center;
        padding: 0;
        border-radius: 4px;
        transition: color 0.2s;
      }
      .comment-actions .like-button .comment-like-count {
        margin-right: 4px;
      }

      .reply-input-area {
        background-color: #fff;
        padding: 8px;
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
        margin-left: 15px;
      }
      .reply-input-area input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 10px;
      }
      .reply-input-area button {
        white-space: nowrap;
        padding: 6px 12px;
        font-size: 0.875rem;
        background-color: #e5e7eb;
        color: #374151;
        border: none;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease-in-out;
      }
      .reply-input-area button:hover {
        background-color: #d1d5db;
      }

      .view-replies-toggle {
        color: #374151 !important;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 4px;
        display: block;
        text-align: left;
        padding: 4px 0;
        cursor: pointer;
        margin-left: 0px;
        background: transparent !important;
        box-shadow: none !important;
      }
      .view-replies-toggle:hover {
        text-decoration: underline;
        color: #3b82f6 !important;
      }
      .replies-list {
        margin-left: 0px;
        padding-left: 0px;
      }
    </style>
  </head>
  <body>
    <!-- 툴바 -->
    <nav class="toolbar">
      <div class="toolbar-left">
        <a href="/Summer_Project/html/index.html" class="logo">오늘의 한 줄</a>
      </div>
      <ul class="toolbar-right memberInfo">
        <li id="profileLoginButton">
          <a href="/Summer_Project/html/login.html">
            <img
              src="https://img.cgv.co.kr/R2014/images/common/ico/loginPassword.png"
              alt="로그인"
              onerror="this.src='https://placehold.co/36x36/ccc/000?text=로그인';"
            />
            <span>로그인</span>
          </a>
        </li>
        <li id="profileSignupButton">
          <a href="/Summer_Project/html/signup.html">
            <img
              src="https://img.cgv.co.kr/R2014/images/common/ico/loginJoin.png"
              alt="회원가입"
              onerror="this.src='https://placehold.co/36x36/ccc/000?text=회원가입';"
            />
            <span>회원가입</span>
          </a>
        </li>
        <li id="profileLogoutButton" style="display: none">
          <a href="/Summer_Project/html/login.html">
            <img
              src="https://img.cgv.co.kr/R2014/images/common/ico/loginPassword.png"
              alt="로그아웃"
              onerror="this.src='https://placehold.co/36x36/ccc/000?text=로그아웃';"
            />
            <span>로그아웃</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- 프로필 메인 -->
    <div class="profile-container">
      <div class="profile-header">
        <div class="image-section">
          <div class="profile-image-wrapper">
            <img id="profileImage" class="profile-image" alt="프로필 사진" />
          </div>
          <label class="small-button" for="imageInput">사진 변경</label>
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            style="display: none"
          />
        </div>
        <div class="profile-info">
          <h2 id="displayName"></h2>
          <p id="bio"></p>
          <p id="phoneNumber" class="text-gray-600 text-sm mt-2"></p>
          <button id="editProfileBtn">프로필 편집</button>
        </div>
      </div>
    </div>

    <!-- 내가 작성한 게시글 섹션 -->
    <div class="my-posts-section">
      <h3 class="text-2xl font-semibold mb-4 text-gray-800">
        내가 작성한 게시글
      </h3>
      <div
        id="userPostsGrid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-8"
      >
        <!-- User's posts will be dynamically loaded here -->
      </div>
    </div>

    <!-- 프로필 편집 모달 -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3>프로필 편집</h3>
        <input type="text" id="nameInput" placeholder="이름" />
        <input type="text" id="phoneInput" placeholder="전화번호" />
        <textarea id="bioInput" placeholder="소개글"></textarea>
        <button id="saveBtn">저장</button>
        <button id="closeEditModal">닫기</button>
      </div>
    </div>

    <!-- 이미지 확대 모달 -->
    <div class="modal" id="imageModal">
      <div class="modal-content">
        <img src="" alt="확대 이미지" id="modalImage" style="width: 100%" />
        <button id="closeImageModal">닫기</button>
      </div>
    </div>

    <!-- 게시글 상세 보기 모달 -->
    <div id="commentModal" class="modal">
      <div class="modal-content">
        <!-- 게시글 내용 표시 영역 -->
        <div class="modal-post-display">
          <div class="modal-post-content-wrapper p-6">
            <h2
              id="modalPostTitle"
              class="text-2xl font-bold text-gray-800 mb-4"
            >
              게시글 제목
            </h2>
            <img
              id="modalPostImage"
              src=""
              alt="게시글 이미지"
              class="modal-post-image mb-4 hidden"
            />
            <p
              id="modalPostText"
              class="text-gray-800 leading-relaxed mb-2"
            ></p>
            <div
              id="modalPostTags"
              class="mt-2 flex flex-wrap gap-2 mb-4"
            ></div>
            <div class="flex items-center text-sm text-gray-500 mt-4">
              <span
                id="modalPostAuthor"
                class="font-semibold text-gray-700 mr-2"
              ></span>
              <span id="modalPostTime"></span>
            </div>
          </div>
        </div>

        <!-- 댓글 작성 및 목록 영역 -->
        <div class="modal-comment-area">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">댓글</h2>
          <div id="modalCommentList" class="comment-list space-y-3">
            <!-- 댓글이 여기에 동적으로 추가됩니다 -->
          </div>
          <div class="flex mt-auto pt-4 border-t border-gray-200">
            <input
              type="text"
              id="modalCommentInput"
              placeholder="댓글을 작성하세요..."
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              id="modalCommentSubmitButton"
              class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200"
            >
              등록
            </button>
          </div>
        </div>

        <!-- 모달 닫기 버튼 -->
        <button
          id="closeCommentModalButton"
          class="absolute top-4 right-4"
          aria-label="모달 닫기"
        >
          &times;
        </button>
      </div>
    </div>

    <!-- 커스텀 확인 모달 -->
    <div class="modal" id="confirmationModal">
      <div class="modal-content">
        <h3 id="confirmationMessage" class="mb-4 text-lg"></h3>
        <button
          id="confirmYesBtn"
          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
        >
          네
        </button>
        <button
          id="confirmNoBtn"
          class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded ml-2"
        >
          아니오
        </button>
      </div>
    </div>

    <!-- 커스텀 알림 모달 -->
    <div class="modal" id="alertDialog">
      <div class="modal-content">
        <h3 id="alertMessage" class="mb-4 text-lg"></h3>
        <button
          id="closeAlertModal"
          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded"
        >
          확인
        </button>
      </div>
    </div>

    <!-- 전체 삭제 버튼 (마이페이지용) -->
    <div style="text-align: center; margin: 30px">
      <button id="clearAllBtn">🗑 모든 게시글/댓글 삭제</button>
    </div>

    <script>
      // 프로필 페이지 관련 DOM 요소
      const profileImage = document.getElementById("profileImage");
      const imageInput = document.getElementById("imageInput");
      const displayNameElement = document.getElementById("displayName");
      const bioElement = document.getElementById("bio");
      const phoneNumberElement = document.getElementById("phoneNumber");
      const editProfileBtn = document.getElementById("editProfileBtn");
      const userPostsGrid = document.getElementById("userPostsGrid");
      const clearAllBtn = document.getElementById("clearAllBtn");

      // 프로필 편집 모달 관련 DOM 요소
      const editModal = document.getElementById("editModal");
      const nameInput = document.getElementById("nameInput");
      const phoneInput = document.getElementById("phoneInput");
      const bioInput = document.getElementById("bioInput");
      const saveBtn = document.getElementById("saveBtn");
      const closeEditModal = document.getElementById("closeEditModal");

      // 이미지 확대 모달 관련 DOM 요소
      const imageModal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");
      const closeImageModal = document.getElementById("closeImageModal");

      // 게시글 상세 보기(댓글) 모달 관련 DOM 요소
      const commentModal = document.getElementById("commentModal");
      const modalPostTitle = document.getElementById("modalPostTitle");
      const modalPostImage = document.getElementById("modalPostImage");
      const modalPostText = document.getElementById("modalPostText");
      const modalPostTags = document.getElementById("modalPostTags");
      const modalPostAuthor = document.getElementById("modalPostAuthor");
      const modalPostTime = document.getElementById("modalPostTime");
      const modalCommentList = document.getElementById("modalCommentList");
      const modalCommentInput = document.getElementById("modalCommentInput");
      const modalCommentSubmitButton = document.getElementById(
        "modalCommentSubmitButton"
      );
      const closeCommentModalButton = document.getElementById(
        "closeCommentModalButton"
      );

      // 로그인/로그아웃 버튼 (툴바)
      const profileLoginButton = document.getElementById("profileLoginButton");
      const profileSignupButton = document.getElementById(
        "profileSignupButton"
      );
      const profileLogoutButton = document.getElementById(
        "profileLogoutButton"
      );

      // 상태 관리 변수
      let currentUserProfile = {};
      let allPosts = [];
      let currentViewingPostCard = null; // 현재 팝업으로 보고 있는 게시글 데이터

      // =================================================================
      // 🌐 데이터 관리 함수 (메인 페이지와 공유되는 핵심 로직)
      // =================================================================

      /**
       * 로컬 스토리지에서 게시글 데이터를 로드하고, 데이터 구조를 최신으로 마이그레이션합니다.
       */
      function loadPosts() {
        const storedPosts = localStorage.getItem("snsPosts");
        if (storedPosts) {
          allPosts = JSON.parse(storedPosts);
          // 데이터 구조 마이그레이션 (하위 호환성 보장)
          allPosts.forEach((post) => {
            if (!post.likedBy) post.likedBy = []; // 게시글 likedBy 추가
            if (!post.comments) post.comments = [];

            const migrateComments = (comments) => {
              comments.forEach((comment) => {
                // 'likers' 또는 'likes' 속성이 있다면 'likedBy'로 변환
                if (comment.likers && !comment.likedBy) {
                  comment.likedBy = [...comment.likers];
                  delete comment.likers;
                } else if (!comment.likedBy) {
                  comment.likedBy = [];
                }
                // 예전 속성 삭제
                delete comment.likes;
                delete comment.liked;

                if (!comment.replies) {
                  comment.replies = [];
                } else {
                  migrateComments(comment.replies); // 재귀적으로 답글도 마이그레이션
                }
              });
            };
            migrateComments(post.comments);
          });
        } else {
          allPosts = [];
        }
      }

      /**
       * 현재 게시글 데이터를 로컬 스토리지에 저장합니다.
       */
      function savePosts() {
        localStorage.setItem("snsPosts", JSON.stringify(allPosts));
      }

      // =================================================================
      // 👤 프로필 관리 함수 (프로필 페이지 고유 로직)
      // =================================================================

      /**
       * 로그인된 사용자 정보를 로드하고 화면에 표시합니다.
       */
      function loadUserProfile() {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (!loggedInUser) {
          displayNameElement.textContent = "로그인 필요";
          bioElement.textContent = "프로필을 보려면 로그인하세요.";
          profileImage.src = getRandomProfileUrl();
          editProfileBtn.style.display = "none";
          profileLoginButton.style.display = "list-item";
          profileSignupButton.style.display = "list-item";
          profileLogoutButton.style.display = "none";
          userPostsGrid.innerHTML =
            '<p class="text-gray-500 text-center col-span-full">게시글을 보려면 로그인해주세요.</p>';
          return;
        }

        const users = JSON.parse(localStorage.getItem("users")) || [];
        const user = users.find((u) => u.username === loggedInUser);

        if (user) {
          currentUserProfile = {
            username: user.username,
            bio: user.bio || "인사말을 작성해주세요.",
            phoneNumber: user.phoneNumber || "전화번호 없음",
            profileImageBase64:
              user.profileImageBase64 || getRandomProfileUrl(),
          };
          displayNameElement.textContent = currentUserProfile.username;
          bioElement.textContent = currentUserProfile.bio;
          phoneNumberElement.textContent = currentUserProfile.phoneNumber;
          profileImage.src = currentUserProfile.profileImageBase64;
          editProfileBtn.style.display = "block";
          profileLoginButton.style.display = "none";
          profileSignupButton.style.display = "none";
          profileLogoutButton.style.display = "list-item";

          loadPosts(); // 게시글 데이터 로드
          renderUserPosts(); // 사용자 게시글 렌더링
        } else {
          localStorage.removeItem("loggedInUser");
          loadUserProfile(); // 재귀 호출로 로그인 화면 상태로 전환
        }
      }

      /**
       * 변경된 프로필 정보를 저장합니다.
       */
      function saveUserProfile() {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (!loggedInUser) return;

        let users = JSON.parse(localStorage.getItem("users")) || [];
        const userIndex = users.findIndex((u) => u.username === loggedInUser);

        if (userIndex !== -1) {
          users[userIndex] = { ...users[userIndex], ...currentUserProfile };
          localStorage.setItem("users", JSON.stringify(users));
        }
      }

      function getRandomProfileUrl() {
        const randomId = Math.floor(Math.random() * 70) + 1;
        return `https://marketplace.canva.com/EAGJIUknLqs/2/0/1600w/canva-%EB%82%A8%EC%83%89-%ED%96%89%EC%84%B1-%EC%9A%B0%EC%A3%BC%EB%B9%84%ED%96%89%EC%82%AC-%EC%9D%BC%EB%9F%AC%EC%8A%A4%ED%8A%B8-%EC%97%AC%ED%96%89-%ED%83%90%ED%97%98-%EC%BB%B4%ED%93%A8%ED%84%B0-%EB%B0%B0%EA%B2%BD%ED%99%94%EB%A9%B4-qOyFvDSniwE.jpg`;
      }

      /**
       * 로그인한 사용자의 게시글만 필터링하여 화면에 렌더링합니다.
       */
      function renderUserPosts() {
        userPostsGrid.innerHTML = "";
        const loggedInUser = localStorage.getItem("loggedInUser");
        const userPosts = allPosts.filter(
          (post) => post.author === loggedInUser
        );

        if (userPosts.length === 0) {
          userPostsGrid.innerHTML =
            '<p class="text-gray-500 text-center col-span-full">아직 작성한 게시글이 없습니다.</p>';
          return;
        }

        userPosts.forEach((post) => {
          const postCard = createPostCardElement(post); // 메인 페이지와 동일한 카드 생성 함수 사용
          userPostsGrid.appendChild(postCard);
        });
      }

      /**
       * 게시글 데이터로 DOM 요소를 생성합니다. (메인 페이지의 카드와 동일한 모양)
       */

      function createPostCardElement(postData) {
        const postCard = document.createElement("div");
        postCard.classList.add("post-card");
        postCard.dataset.postId = postData.id;

        const truncatedContent =
          postData.text.length > 50
            ? postData.text.substring(0, 47) + "..."
            : postData.text;
        let imageHtml = postData.imageUrl
          ? `<img src="${postData.imageUrl}" alt="게시글 이미지" class="post-card-image">`
          : "";

        postCard.innerHTML = `
            ${imageHtml}
            <div class="post-card-content-wrapper">
                <h4 class="post-card-title">${
                  postData.text.split("\n")[0] || "제목 없음"
                }</h4>
                <p class="post-card-text">${truncatedContent}</p>
            </div>
            <button class="post-card-delete-btn">삭제</button>
        `;

        // 카드 전체 클릭 시 상세 보기 팝업 열기
        postCard.addEventListener("click", (event) => {
          // 삭제 버튼이 아닌 영역을 클릭했을 때만 팝업 열기
          if (!event.target.classList.contains("post-card-delete-btn")) {
            openPostViewModal(postData.id);
          }
        });

        /**
         * 특정 ID의 게시글을 삭제하는 함수
         * @param {string} postId 삭제할 게시글의 ID
         */
        function deletePost(postId) {
          // 해당 ID를 가진 게시글을 제외하고 새로운 배열을 만듭니다.
          allPosts = allPosts.filter((post) => post.id !== postId);

          // 변경된 게시글 목록을 로컬 스토리지에 저장합니다.
          savePosts();

          // 게시글 목록을 다시 렌더링하여 화면에서 삭제된 것처럼 보이게 합니다.
          renderUserPosts();

          alert("게시글이 삭제되었습니다.");
        }

        // 삭제 버튼에 이벤트 리스너 추가
        const deleteBtn = postCard.querySelector(".post-card-delete-btn");
        deleteBtn.addEventListener("click", (event) => {
          event.stopPropagation(); // 카드 전체 클릭 이벤트 방지
          // 사용자에게 삭제 여부 확인
          if (confirm("이 게시글을 정말 삭제하시겠습니까?")) {
            deletePost(postData.id);
          }
        });

        return postCard;
      }
      /**
       * 사용자 이름 변경 시 모든 게시물/댓글/답글의 작성자 정보를 업데이트합니다.
       * @param {string} oldUsername 이전 사용자 이름
       * @param {string} newUsername 새로운 사용자 이름
       */
      function updateDataOnUsernameChange(oldUsername, newUsername) {
        allPosts.forEach((post) => {
          // 게시글 작성자 이름 변경
          if (post.author === oldUsername) {
            post.author = newUsername;
          }
          // 댓글과 답글의 작성자 이름 변경 (재귀 함수 사용)
          const updateCommentUsername = (comments) => {
            if (!comments) return;
            comments.forEach((comment) => {
              if (comment.username === oldUsername) {
                comment.username = newUsername;
              }
              if (comment.replies) {
                updateCommentUsername(comment.replies); // 답글도 재귀적으로 처리
              }
            });
          };
          updateCommentUsername(post.comments);
        });
        // 변경된 전체 데이터를 저장합니다.
        savePosts();
      }
      /**
       * 게시글 상세 보기 팝업(댓글 모달)을 엽니다.
       */
      function openPostViewModal(postId) {
        const postData = allPosts.find((p) => p.id === postId);
        if (!postData) return;

        currentViewingPostCard = postData; // 현재 보고 있는 게시글 데이터 설정

        // 팝업에 게시글 내용 채우기
        modalPostTitle.textContent =
          postData.text.split("\n")[0] || "제목 없음";
        modalPostText.textContent = postData.text;
        modalPostAuthor.textContent = `작성자: ${postData.author}`;
        modalPostTime.textContent = postData.time;

        if (postData.imageUrl) {
          modalPostImage.src = postData.imageUrl;
          modalPostImage.classList.remove("hidden");
        } else {
          modalPostImage.classList.add("hidden");
          modalPostImage.src = "";
        }

        modalPostTags.innerHTML = (postData.tags || [])
          .map(
            (tag) =>
              `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">#${tag}</span>`
          )
          .join("");

        // 댓글 목록 렌더링 (메인 페이지와 공유되는 함수 호출)
        window.renderComments(postData.comments || [], modalCommentList);
        commentModal.style.display = "flex";
      }

      window.renderComments = function (comments, container, isReply = false) {
        container.innerHTML = "";
        const loggedInUser = localStorage.getItem("loggedInUser");

        if (!comments || comments.length === 0) {
          const noCommentMessage = document.createElement("p");
          noCommentMessage.classList.add(
            "text-gray-500",
            "text-center",
            "py-4"
          );
          noCommentMessage.textContent = isReply
            ? "아직 답글이 없습니다."
            : "아직 댓글이 없습니다. 첫 댓글을 남겨보세요!";
          container.appendChild(noCommentMessage);
          return;
        }

        comments.forEach((comment) => {
          const hasUserLikedComment =
            loggedInUser && (comment.likedBy || []).includes(loggedInUser);
          const commentItem = document.createElement("div");
          commentItem.dataset.id = comment.id;
          commentItem.classList.add(isReply ? "reply-item" : "comment-item");

          commentItem.innerHTML = `
                <div class="comment-content-wrapper">
                    <div class="comment-text-line">
                        <span class="comment-username">${
                          comment.username
                        }</span>
                        <span class="comment-body">${comment.text}</span>
                    </div>
                    <div class="comment-time">${comment.time}</div>
                </div>
                <div class="comment-actions">
                    <button class="like-button ${
                      hasUserLikedComment ? "text-red-500" : "text-gray-500"
                    }" onclick="window.toggleCommentLike(this)">
                        <span class="comment-like-count">${
                          (comment.likedBy || []).length
                        }개</span> 좋아요
                    </button>
                    ${
                      !isReply
                        ? `<button onclick="window.toggleReplyInput(this)">답글 달기</button>`
                        : ""
                    }
                </div>
                <div class="reply-input-area hidden mt-3">
                    <input type="text" placeholder="답글을 작성하세요..." class="w-full px-3 py-2 text-sm border rounded-lg">
                    <button onclick="window.submitReply(this)">등록</button>
                </div>
                ${
                  !isReply && comment.replies && comment.replies.length > 0
                    ? `<button class="view-replies-toggle" onclick="window.toggleViewReplies(this)">— 답글 보기 (${comment.replies.length}개)</button>`
                    : ""
                }
                <div class="replies-list mt-3 space-y-2 hidden"></div>
            `;
          container.appendChild(commentItem);

          if (comment.replies && comment.replies.length > 0) {
            const repliesListContainer =
              commentItem.querySelector(".replies-list");
            window.renderComments(comment.replies, repliesListContainer, true);
          }
        });
      };

      window.toggleCommentLike = function (button) {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (!loggedInUser) {
          alert("로그인해야 좋아요를 누를 수 있습니다.");
          return;
        }

        const commentItem = button.closest(".comment-item, .reply-item");
        const commentId = commentItem.dataset.id;

        const findCommentOrReply = (commentsArray, id) => {
          for (const item of commentsArray) {
            if (item.id === id) return item;
            if (item.replies) {
              const foundInReplies = findCommentOrReply(item.replies, id);
              if (foundInReplies) return foundInReplies;
            }
          }
          return null;
        };

        const commentObj = findCommentOrReply(
          currentViewingPostCard.comments,
          commentId
        );

        if (commentObj) {
          if (!commentObj.likedBy) commentObj.likedBy = [];
          const likeIndex = commentObj.likedBy.indexOf(loggedInUser);

          if (likeIndex > -1) {
            commentObj.likedBy.splice(likeIndex, 1);
          } else {
            commentObj.likedBy.push(loggedInUser);
          }

          savePosts();
          // UI 직접 업데이트
          const hasUserLiked = commentObj.likedBy.includes(loggedInUser);
          button.classList.toggle("text-red-500", hasUserLiked);
          button.classList.toggle("text-gray-500", !hasUserLiked);
          button.querySelector(
            ".comment-like-count"
          ).textContent = `${commentObj.likedBy.length}개`;
        }
      };

      window.toggleReplyInput = function (button) {
        const commentItem = button.closest(".comment-item");
        const replyInputArea = commentItem.querySelector(".reply-input-area");
        replyInputArea.classList.toggle("hidden");
        if (!replyInputArea.classList.contains("hidden")) {
          replyInputArea.querySelector("input").focus();
        }
      };

      window.submitReply = function (button) {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (!loggedInUser) {
          alert("로그인해야 답글을 작성할 수 있습니다.");
          return;
        }

        const replyInputArea = button.closest(".reply-input-area");
        const replyInput = replyInputArea.querySelector("input");
        const replyText = replyInput.value.trim();
        if (!replyText) {
          alert("답글 내용을 입력해주세요.");
          return;
        }

        const parentCommentItem = replyInputArea.closest(".comment-item");
        const parentCommentId = parentCommentItem.dataset.id;

        const findComment = (commentsArray, id) => {
          for (const item of commentsArray) {
            if (item.id === id) return item;
            if (item.replies) {
              const found = findComment(item.replies, id);
              if (found) return found;
            }
          }
          return null;
        };

        const parentCommentObj = findComment(
          currentViewingPostCard.comments,
          parentCommentId
        );

        if (parentCommentObj) {
          const now = new Date();
          const options = {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "numeric",
            minute: "numeric",
            hour12: true,
          };
          const currentTimeFormatted = now.toLocaleString("ko-KR", options);

          const newReply = {
            id: "reply-" + Date.now(),
            username: loggedInUser,
            text: replyText,
            time: currentTimeFormatted,
            likedBy: [],
            replies: [], // 답글의 답글도 가능하도록 replies 배열 추가
          };

          if (!parentCommentObj.replies) parentCommentObj.replies = [];
          parentCommentObj.replies.push(newReply);

          savePosts();
          // UI 즉시 업데이트
          window.renderComments(
            currentViewingPostCard.comments,
            modalCommentList
          );
        }
      };

      window.toggleViewReplies = function (button) {
        const commentItem = button.closest(".comment-item");
        const repliesList = commentItem.querySelector(".replies-list");
        const isHidden = repliesList.classList.contains("hidden");

        repliesList.classList.toggle("hidden");
        button.textContent = isHidden
          ? `— 답글 숨기기 (${repliesList.children.length}개)`
          : `— 답글 보기 (${repliesList.children.length}개)`;
      };

      // 페이지 로드 시 최초 실행
      document.addEventListener("DOMContentLoaded", () => {
        loadUserProfile();

        // 프로필 이미지 변경
        imageInput.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              profileImage.src = e.target.result;
              currentUserProfile.profileImageBase64 = e.target.result;
              saveUserProfile();
            };
            reader.readAsDataURL(file);
          }
        });

        // 프로필 편집 모달 열기
        editProfileBtn.addEventListener("click", () => {
          nameInput.value = currentUserProfile.username;
          phoneInput.value = currentUserProfile.phoneNumber;
          bioInput.value = currentUserProfile.bio;
          editModal.style.display = "flex";
        });

        // 프로필 저장
        saveBtn.addEventListener("click", () => {
          const oldUsername = currentUserProfile.username; // 변경 전 이름 저장
          const newUsername = nameInput.value.trim(); // 변경 후 이름

          // 프로필 정보 객체 업데이트
          currentUserProfile.username = newUsername;
          currentUserProfile.phoneNumber = phoneInput.value.trim();
          currentUserProfile.bio = bioInput.value.trim();

          // users 배열에 프로필 정보 저장
          saveUserProfile();

          // 이름이 실제로 변경되었는지 확인
          if (oldUsername !== newUsername) {
            // 1. 현재 로그인 정보를 새 이름으로 업데이트
            localStorage.setItem("loggedInUser", newUsername);
            // 2. 모든 게시물/댓글의 작성자 정보를 새 이름으로 업데이트
            updateDataOnUsernameChange(oldUsername, newUsername);
          }

          // 변경된 정보로 프로필 화면 다시 로드
          loadUserProfile();
          editModal.style.display = "none";
          alert("프로필이 성공적으로 저장되었습니다!");
        });

        // 프로필 편집 모달 닫기
        closeEditModal.addEventListener(
          "click",
          () => (editModal.style.display = "none")
        );

        // 게시글 상세 팝업 닫기
        closeCommentModalButton.addEventListener(
          "click",
          () => (commentModal.style.display = "none")
        );

        // 댓글 등록 버튼
        modalCommentSubmitButton.addEventListener("click", () => {
          const loggedInUser = localStorage.getItem("loggedInUser");
          if (!loggedInUser) {
            alert("로그인해야 댓글을 작성할 수 있습니다.");
            return;
          }

          const commentText = modalCommentInput.value.trim();
          if (commentText && currentViewingPostCard) {
            const now = new Date();
            const options = {
              year: "numeric",
              month: "long",
              day: "numeric",
              hour: "numeric",
              minute: "numeric",
              hour12: true,
            };
            const currentTimeFormatted = now.toLocaleString("ko-KR", options);

            const newComment = {
              id: "comment-" + Date.now(),
              username: loggedInUser,
              text: commentText,
              time: currentTimeFormatted,
              likedBy: [],
              replies: [],
            };

            if (!currentViewingPostCard.comments)
              currentViewingPostCard.comments = [];
            currentViewingPostCard.comments.push(newComment);
            savePosts();

            window.renderComments(
              currentViewingPostCard.comments,
              modalCommentList
            );
            modalCommentInput.value = "";
            modalCommentList.scrollTop = modalCommentList.scrollHeight;
          }
        });

        // 로그아웃
        profileLogoutButton.addEventListener("click", () => {
          localStorage.removeItem("loggedInUser");
          window.location.reload();
        });
      });
    </script>
  </body>
</html>
